{% if new %}
    {% set action = '?/users/new' %}
{% else %}
    {% set action = '?/users/' ~ user.id %}
{% endif %}

<form action="{{ action }}" method="post">
    <input type="hidden" name="token" value="{{ token }}">
    <table>
        <tr>
            <th>{% trans 'Username' %}</th>
            <td>
                {% if new or mod|hasPermission(config.mod.editusers) %}
                    <input size="20" maxlength="30" type="text" name="username" value="{{ user.username|e }}" autocomplete="off">
                {% else %}
                    {{ user.username|e }}
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>{% trans 'Password' %}{% if not new %} <small style="font-weight:normal">({% trans 'new; optional' %})</small>{% endif %}</th>
            <td>
                {% if new or (mod|hasPermission(config.mod.editusers) or (mod|hasPermission(config.mod.change_password) and user.id == mod.id)) %}
                    <input size="20" maxlength="30" type="password" name="password" value="" autocomplete="off">
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        {% if new %}
            <tr>
                <th>{% trans 'Group' %}</th>
                <td>
                    <ul style="padding:5px 8px;list-style:none">
                        {% for group_value, group_name in config.mod.groups %}
                            {% if group_name != 'Disabled' %}
                                <li>
                                    <input type="radio" name="type" id="group_{{ group_name }}" value="{{ group_value }}"> 
                                    <label for="group_{{ group_name }}">{{ group_name|trans }}</label>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </td>
            </tr>
        {% endif %}
        <tr>
            <th>{% trans 'Boards' %}</th>
            <td>
                {% if mod|hasPermission(config.mod.editusers) %}
                    <input type="text" id="boardInput" placeholder="Enter board URI, title, or * for all boards">
                    <ul id="boardSuggestions" style="list-style:none; padding:0; margin:0; border:1px solid #ccc; max-height:120px; overflow:auto; display:none;"></ul>
                    <div id="selectedBoards" style="margin-top:5px;">
                        {% for board_uri in user.boards %}
                            <span class="board-tag" data-board="{{ board_uri }}">
                                {{ board_uri }}
                                <button type="button" onclick="removeBoard('{{ board_uri }}')">×</button>
                            </span>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="boards" id="boardsHidden" value="{{ user.boards|join(',') }}">
                {% else %}
                    {{ user.boards|join(', ') }}
                {% endif %}
            </td>
        </tr>
    </table>
    
    <ul style="padding:0;text-align:center;list-style:none">
        {% if new %}
            <li><input type="submit" value="{% trans 'Create user' %}"></li>
        {% else %}
            <li><input type="submit" value="{% trans 'Save changes' %}"></li>
            {% if mod|hasPermission(config.mod.deleteusers) %}
                <li><input name="delete" onclick="return confirm('Are you sure you want to permanently delete this user?');" type="submit" value="{% trans 'Delete user' %}"></li>
            {% endif %}
        {% endif %}
    </ul>
</form>

{% if logs and logs|length > 0 %}
    <table class="modlog" style="width:600px">
        <tr>
            <th>{% trans 'IP address' %}</th>            
            <th>{% trans 'Time' %}</th>
            <th>{% trans 'Board' %}</th>
            <th>{% trans 'Action' %}</th>
        </tr>
        {% for log in logs %}
            <tr>
                <td class="minimal">
                    <a href="?/IP/{{ log.ip|cloak_ip }}">{{ log.ip|cloak_ip }}</a>
                </td>
                <td class="minimal">
                    <span title="{{ log.time|date(config.post_date) }}">{{ log.time|ago }}</span>
                </td>
                <td class="minimal">
                    {% if log.board %}
                        <a href="?/{{ config.board_path|sprintf(log.board) }}{{ config.file_index }}">{{ config.board_abbreviation|sprintf(log.board) }}</a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {{ log.text }}
                </td>
            </tr>
        {% endfor %}
    </table>
    <p style="text-align:center" class="unimportant">
        <a href="?/log:{{ user.username|e }}">{% trans 'View more logs for this user.' %}</a>
    </p>
{% endif %}

<script>
    const boardInput = document.getElementById('boardInput');
    const suggestions = document.getElementById('boardSuggestions');
    const selectedBoardsDiv = document.getElementById('selectedBoards');
    const boardsHidden = document.getElementById('boardsHidden');
    const csrfToken = '{{ token }}';

    function updateHiddenField() {
        const boardTags = Array.from(selectedBoardsDiv.querySelectorAll('.board-tag'))
            .map(tag => tag.getAttribute('data-board'));
        boardsHidden.value = boardTags.join(',');
    }

    function removeBoard(uri) {
        const el = selectedBoardsDiv.querySelector(`[data-board="${uri}"]`);
        if (el) el.remove();
        updateHiddenField();
    }

    function addBoard(uri) {
        if (!uri) return;
        if (!selectedBoardsDiv.querySelector(`[data-board="${uri}"]`)) {
            const span = document.createElement('span');
            span.className = 'board-tag';
            span.setAttribute('data-board', uri);
            span.innerHTML = `${uri} <button type="button" onclick="removeBoard('${uri}')">×</button>`;
            selectedBoardsDiv.appendChild(span);
            updateHiddenField();
        }
    }

    let debounceTimeout;
    boardInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(async () => {
            const val = boardInput.value.trim().toLowerCase();
            suggestions.innerHTML = '';
            if (!val) { 
                suggestions.style.display = 'none'; 
                return; 
            }

            try {
                const response = await fetch('?/board_suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `query=${encodeURIComponent(val)}&token=${encodeURIComponent(csrfToken)}`
                });
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                if (data.error) {
                    console.error('Error:', data.error);
                    suggestions.style.display = 'none';
                    return;
                }

                if (data.boards.length) {
                    suggestions.style.display = 'block';
                    data.boards.forEach(board => {
                        const li = document.createElement('li');
                        li.style.cursor = 'pointer';
                        li.style.padding = '2px 5px';
                        li.innerHTML = `<strong>${board.uri}</strong> (${board.title})`;
                        li.onclick = () => {
                            addBoard(board.uri);
                            boardInput.value = '';
                            suggestions.style.display = 'none';
                        };
                        suggestions.appendChild(li);
                    });
                } else {
                    suggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching board suggestions:', error);
                suggestions.style.display = 'none';
            }
        }, 300);
    });

    boardInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = boardInput.value.trim().toLowerCase();
            if (val) {
                addBoard(val);
                boardInput.value = '';
                suggestions.style.display = 'none';
            }
        }
    });
</script>
<form style="width:300px;margin:auto" action="?/rebuild" method="post">
    <input type="hidden" name="token" value="{{ token }}">
    <ul id="rebuild">
        <li style="margin-bottom:8px">
            <input type="checkbox" name="rebuild_all" id="rebuild_all" onchange="toggleall(this.checked)">
            <label for="rebuild_all"><strong>{% trans 'Toggle all' %}</strong></label>
            <script>
                function toggleall(val) {
                    var elements = document.getElementById('rebuild').querySelectorAll('input[type=checkbox]');
                    for (var i = 0; i < elements.length; i++) {
                        elements[i].checked = val;
                    }
                }
            </script>
        </li>
        <li>
            <input type="checkbox" name="rebuild_cache" id="rebuild_cache" checked>
            <label for="rebuild_cache">{% trans 'Flush cache' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_javascript" id="rebuild_javascript" checked>
            <label for="rebuild_javascript">{% trans 'Rebuild Javascript' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_index" id="rebuild_index" checked>
            <label for="rebuild_index">{% trans 'Rebuild index pages' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_threads" id="rebuild_threads" checked>
            <label for="rebuild_threads">{% trans 'Rebuild threads' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_posts" id="rebuild_posts">
            <label for="rebuild_posts">{% trans 'Rebuild replies' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_themes" id="rebuild_themes" checked>
            <label for="rebuild_themes">{% trans 'Rebuild themes' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_archive" id="rebuild_archive">
            <label for="rebuild_archive">{% trans 'Rebuild archive index' %}</label>
        </li>
        <li>
            <input type="checkbox" name="rebuild_catalog" id="rebuild_catalog">
            <label for="rebuild_catalog">{% trans 'Rebuild catalog index' %}</label>
        </li>
    </ul>

    <hr>

    <div style="margin-bottom:8px">
        <label for="rebuildBoardInput"><strong>{% trans 'Boards (comma-separated, * for all)' %}</strong></label><br>
        <input type="text" id="rebuildBoardInput" placeholder="Enter board URI, title, or * for all boards" style="width:280px;">
        <ul id="rebuildBoardSuggestions" style="list-style:none; padding:0; margin:0; border:1px solid #ccc; max-height:120px; overflow:auto; display:none; position:absolute; background:white; z-index:10;"></ul>
        <div id="rebuildSelectedBoards" style="margin-top:5px;"></div>
        <input type="hidden" name="boards_input" id="rebuildBoardsHidden">
    </div>

    <p style="text-align:center">
        <input type="submit" value="{% trans 'Rebuild' %}" name="rebuild">
    </p>
</form>

<script>
    const rebuildBoardInput = document.getElementById('rebuildBoardInput');
    const rebuildSuggestions = document.getElementById('rebuildBoardSuggestions');
    const rebuildSelectedBoardsDiv = document.getElementById('rebuildSelectedBoards');
    const rebuildBoardsHidden = document.getElementById('rebuildBoardsHidden');
    const rebuildCsrfToken = '{{ suggestions_token|default(token) }}';

    function updateRebuildHiddenField() {
        const boardTags = Array.from(rebuildSelectedBoardsDiv.querySelectorAll('.board-tag'))
            .map(tag => tag.getAttribute('data-board'));
        rebuildBoardsHidden.value = boardTags.join(',');
    }

    function removeRebuildBoard(uri) {
        const el = rebuildSelectedBoardsDiv.querySelector(`[data-board="${uri}"]`);
        if (el) el.remove();
        updateRebuildHiddenField();
    }

    function addRebuildBoard(uri) {
        if (!uri) return;
        if (!rebuildSelectedBoardsDiv.querySelector(`[data-board="${uri}"]`)) {
            const span = document.createElement('span');
            span.className = 'board-tag';
            span.setAttribute('data-board', uri);
            span.style.marginRight = '4px';
            span.innerHTML = `${uri} <button type="button" onclick="removeRebuildBoard('${uri}')">×</button>`;
            rebuildSelectedBoardsDiv.appendChild(span);
            updateRebuildHiddenField();
        }
    }

    let rebuildDebounceTimeout;
    rebuildBoardInput.addEventListener('input', () => {
        clearTimeout(rebuildDebounceTimeout);
        rebuildDebounceTimeout = setTimeout(async () => {
            const val = rebuildBoardInput.value.trim().toLowerCase();
            rebuildSuggestions.innerHTML = '';
            if (!val) {
                rebuildSuggestions.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('?/board_suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `query=${encodeURIComponent(val)}&token=${encodeURIComponent(rebuildCsrfToken)}`
                });
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                if (data.error) {
                    console.error('Error:', data.error);
                    rebuildSuggestions.style.display = 'none';
                    return;
                }

                if (data.boards.length) {
                    rebuildSuggestions.style.display = 'block';
                    data.boards.forEach(board => {
                        const li = document.createElement('li');
                        li.style.cursor = 'pointer';
                        li.style.padding = '2px 5px';
                        li.innerHTML = `<strong>${board.uri}</strong> (${board.title})`;
                        li.onclick = () => {
                            addRebuildBoard(board.uri);
                            rebuildBoardInput.value = '';
                            rebuildSuggestions.style.display = 'none';
                        };
                        rebuildSuggestions.appendChild(li);
                    });
                } else {
                    rebuildSuggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching board suggestions:', error);
                rebuildSuggestions.style.display = 'none';
            }
        }, 300);
    });

    rebuildBoardInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = rebuildBoardInput.value.trim().toLowerCase();
            if (val) {
                addRebuildBoard(val);
                rebuildBoardInput.value = '';
                rebuildSuggestions.style.display = 'none';
            }
        }
    });

    // Allow clicking outside to close suggestions
    document.addEventListener('click', function(e) {
        if (!rebuildSuggestions.contains(e.target) && e.target !== rebuildBoardInput) {
            rebuildSuggestions.style.display = 'none';
        }
    });
</script>